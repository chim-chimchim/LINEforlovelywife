<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¦»LINE åœ°é›·ãƒã‚§ãƒƒã‚«ãƒ¼ Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --accent: #ff6b6b;
      --accent-soft: #ffe3e3;
      --safe: #2ecc71;
      --warn: #f1c40f;
      --danger: #e67e22;
      --deadly: #e74c3c;
      --text-main: #333333;
      --text-muted: #666666;
      --border-soft: #e0e0e6;
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.06);
      --radius-lg: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffe9f0, #f5f5f7 60%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 520px;
      background: #ffffffcc;
      border-radius: 24px;
      padding: 18px 16px 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.8);
      backdrop-filter: blur(8px);
    }

    header {
      text-align: center;
      margin-bottom: 14px;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.logo {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ff9a9e, #ff6b6b);
      color: #fff;
      font-size: 1.2rem;
    }

    header p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 6px 0 0;
    }

    .supporter-badge {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #fff5d9;
      color: #a36b00;
      border: 1px solid #ffe0a3;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 12px 12px 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      border: 1px solid var(--border-soft);
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card-title small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    label {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }

    textarea:focus {
      border-color: #ff9a9e;
      box-shadow: 0 0 0 1px #ff9a9e33;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 0.85rem;
      outline: none;
      background: #fafafa;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff9a9e, #ff6b6b);
      color: #fff;
      box-shadow: 0 4px 10px rgba(255,107,107,0.35);
      flex: 1;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(255,107,107,0.35);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-soft);
      font-weight: 500;
      padding-inline: 12px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .plays-info {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 4px;
      flex-wrap: wrap;
    }

    .plays-info span.highlight {
      font-weight: 600;
      color: #ff6b6b;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-safe    { background:#e7f7ee; color:#1d8547; }
    .badge-warn    { background:#fff7d6; color:#9c7a02; }
    .badge-danger  { background:#ffe3d3; color:#a04f13; }
    .badge-deadly  { background:#ffe1e1; color:#a4161a; }

    .result-main {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .result-main span.level-text {
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .result-comment {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .result-suggest {
      font-size: 0.85rem;
      color: #444;
    }

    .subtle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .limit-overlay {
      background: var(--accent-soft);
      border-radius: var(--radius-lg);
      padding: 10px 10px 12px;
      border: 1px dashed #ff9a9e;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .limit-title {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .limit-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn-outline-accent {
      border: 1px solid #ff9a9e;
      background: #fff;
      color: #ff3b5c;
      flex: 1;
    }

    .btn-muted {
      border: 1px solid var(--border-soft);
      background: #fafafa;
      color: var(--text-muted);
      flex: 1;
    }

    .share-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-x {
      background: #000;
      color: #fff;
      flex: 1;
    }

    .btn-copy {
      background: #f0f0f3;
      color: #333;
      flex: 1;
    }

    .support-card p {
      margin: 4px 0;
      font-size: 0.85rem;
    }

    .support-buttons {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .support-buttons a {
      text-decoration: none;
    }

    .btn-support {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.8rem;
      border: 1px solid #ffd3e0;
      background: #fff7fb;
      color: #c54a7c;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .footer-note {
      text-align: center;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .debug-section {
      margin-top: 6px;
      border-top: 1px dashed #eee;
      padding-top: 6px;
    }

    .debug-section summary {
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 50;
    }

    .toast.show { opacity: 1; }

    @media (max-width: 400px) {
      .card { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>
        <span class="logo">ğŸ’£</span>
        å¦»LINE åœ°é›·ãƒã‚§ãƒƒã‚«ãƒ¼ Lite
      </h1>
      <p>é€ã‚‹å‰ã«ã€ã“ã“ã§ä¸€å›ã ã‘çˆ†ç™ºã•ã›ã¦ãŠã“ã†ã€‚</p>
      <div id="supporterBadge" class="supporter-badge" style="display:none;">
        <span>âœ¨</span> ã‚µãƒãƒ¼ã‚¿ãƒ¼ã•ã‚“ã€ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
      </div>
    </header>

    <!-- å…¥åŠ›ï¼†è¨ºæ–­ -->
    <section class="card">
      <div class="card-title">
        <span>1. å¦»ã¸ã®LINEã‚’è‡ªç”±ã«å…¥åŠ›</span>
        <small id="todayLabel"></small>
      </div>
      <label for="lineText">å®Ÿéš›ã«é€ã‚ã†ã¨ã—ã¦ã„ã‚‹æ–‡ç« ã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„</label>
      <textarea id="lineText" placeholder="ä¾‹ï¼‰ã•ã£ãã®è¨€ã„æ–¹ã¯ã¡ã‚‡ã£ã¨ã‚­ãƒ„ããªã„ï¼Ÿä¿ºã ã£ã¦ä»•äº‹ã§ã‚¯ã‚¿ã‚¯ã‚¿ãªã‚“ã ã‘ã©ã€‚å¸°ã‚Šã«ç‰›ä¹³è²·ã£ã¦ãã¦ãã‚Œã‚‹ï¼Ÿ"></textarea>

      <div style="margin-top:8px;">
        <label for="moodSelect">ã„ã¾ã®å¦»ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆé›°å›²æ°—ã§OKï¼‰</label>
        <select id="moodSelect">
          <option value="normal">ãµã¤ã†</option>
          <option value="slightly-angry">ã¡ã‚‡ã„ãŠã“</option>
          <option value="angry">ã‚¬ãƒãŠã“ï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰</option>
        </select>
      </div>

      <div class="row" style="margin-top:9px;">
        <button class="btn btn-primary" id="checkButton">
          ğŸ” åœ°é›·åº¦ã‚’è¨ºæ–­ã™ã‚‹
        </button>
        <button class="btn btn-ghost btn-small" id="sampleButton">
          ã‚µãƒ³ãƒ—ãƒ«æ–‡ã‚’å…¥ã‚Œã‚‹
        </button>
      </div>

      <div class="plays-info">
        <span>æœ¬æ—¥ã®ç„¡æ–™è¨ºæ–­ï¼šã‚ã¨ <span id="playsLeft" class="highlight">3</span> å›</span>
        <span id="unlimitedStatus"></span>
      </div>

      <div id="limitBlock" class="limit-overlay" style="display:none;">
        <div class="limit-title">
          ğŸš§ æœ¬æ—¥ã®ç„¡æ–™è¨ºæ–­ã¯3å›ã¾ã§ã§ã™
        </div>
        <div>100å††ã§ä»Šæ—¥ã ã‘ç„¡åˆ¶é™è¨ºæ–­ã‚’è§£æ”¾ã§ãã¾ã™ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãŸã‚ãƒ€ãƒŸãƒ¼è¡¨ç¤ºã§ã™ï¼‰ã€‚</div>
        <div class="limit-actions">
          <a class="btn btn-outline-accent" id="dummyPaymentLink" href="#">
            ğŸ’³ 100å††ã§ä»Šæ—¥ã ã‘ç„¡åˆ¶é™ã«ã™ã‚‹
          </a>
          <button class="btn btn-muted btn-small" id="limitCloseButton">
            OKï¼ˆä»Šæ—¥ã¯ã“ã‚Œã§ã‚„ã‚ã‚‹ï¼‰
          </button>
        </div>
        <div class="subtle" style="margin-top:6px;">
          â€» æœ¬ç•ªã§ã¯Stripe Payment Linksãªã©ã®æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«é£›ã°ã—ã€<br>
          æˆåŠŸå¾Œã« <code>?payment=success</code> ã‚’ä»˜ã‘ã¦ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã™æƒ³å®šã§ã™ã€‚
        </div>
      </div>
    </section>

    <!-- çµæœ -->
    <section class="card">
      <div class="card-title">
        <span>2. è¨ºæ–­çµæœ</span>
        <small>â€»ãƒã‚¿ï¼†è‡ªæˆ’ãƒ„ãƒ¼ãƒ«ã§ã™</small>
      </div>
      <div id="resultArea">
        <div class="subtle">
          ã“ã“ã«è¨ºæ–­çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
          ã¨ãã«ã€ŒãŠé¡˜ã„ï¼‹è¡Œå‹•è¦æ±‚ã€ã¯ã‹ãªã‚Šåœ°é›·å¯„ã‚Šã«è¦‹ã¾ã™ã€‚
        </div>
      </div>

      <div class="share-row">
        <button class="btn btn-x btn-small" id="shareXButton">
          Xã§çµæœã‚’è‡ªæ…¢ã™ã‚‹
        </button>
        <button class="btn btn-copy btn-small" id="copySummaryButton">
          çµæœã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
    </section>

    <!-- æŠ•ã’éŠ­ -->
    <section class="card support-card">
      <div class="card-title">
        <span>3. é–‹ç™ºè€…ã‚’å¿œæ´ã™ã‚‹ï¼ˆä»»æ„æŠ•ã’éŠ­ï¼‰</span>
      </div>
      <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã¡ã‚‡ã£ã¨ã§ã‚‚ç¬‘ãˆãŸãƒ»å½¹ã«ç«‹ã£ãŸã¨æ€ã£ãŸã‚‰ã€ã‚³ãƒ¼ãƒ’ãƒ¼1æ¯åˆ†ã ã‘æŠ•ã’éŠ­ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å–œã³ã¾ã™â˜•ï¸</p>
      <div class="support-buttons">
        <a href="#" target="_blank" rel="noopener noreferrer">
          <div class="btn-support">100å††ã§å¿œæ´ã™ã‚‹</div>
        </a>
        <a href="#" target="_blank" rel="noopener noreferrer">
          <div class="btn-support">300å††ã§å¿œæ´ã™ã‚‹</div>
        </a>
        <a href="#" target="_blank" rel="noopener noreferrer">
          <div class="btn-support">500å††ã§å…¨åŠ›å¿œæ´ã™ã‚‹</div>
        </a>
      </div>
      <p class="subtle">
        â€» ä»Šã¯ãƒ€ãƒŸãƒ¼ãƒªãƒ³ã‚¯ã§ã™ã€‚æœ¬ç•ªã§ã¯ note / PayPal / Stripe Payment Link ãªã©ã«å·®ã—æ›¿ãˆã¾ã™ã€‚<br>
        â€» æŠ•ã’éŠ­ã—ã¦ã‚‚åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯ä¸€åˆ‡å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚ç´”ç²‹ãªå¿œæ´ã ã‘ã§ã™ã€‚
      </p>

      <div class="debug-section">
        <details>
          <summary>ãƒ‡ãƒãƒƒã‚°ï¼å°†æ¥ã®æ±ºæ¸ˆé€£æºç”¨ãƒ¡ãƒ¢</summary>
          <p class="subtle">
            æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®æˆ»ã‚ŠURLã‚’<br>
            <code>?payment=success</code> ã‚„ <code>?tip=done</code> ã‚’ä»˜ã‘ã¦ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã™ã¨ã€<br>
            å½“æ—¥ã®ç„¡åˆ¶é™ãƒ•ãƒ©ã‚°ï¼ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹æƒ³å®šã§ã™ã€‚
          </p>
          <div class="row">
            <button class="btn btn-muted btn-small" id="debugUnlockButton">
              ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ç„¡åˆ¶é™ãƒ•ãƒ©ã‚°ã‚’ON
            </button>
            <button class="btn btn-muted btn-small" id="debugTipButton">
              ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ©ã‚°ã‚’ON
            </button>
          </div>
        </details>
      </div>
    </section>

    <div class="footer-note">
      â€» å®Ÿéš›ã®å¤«å©¦ã®ä¼šè©±ã§ã¯ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã‚ˆã‚Šç›¸æ‰‹ã®æ°—æŒã¡ã®ã»ã†ãŒå¤§äº‹ã§ã™ğŸ¤
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const KEY_DATE = "wifeBotDate";
    const KEY_PLAYS = "wifeBotPlays";
    const KEY_UNLIMITED = "wifeBotUnlimitedDate";
    const KEY_SUPPORTER = "wifeBotSupporter";

    function getTodayString() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }

    function parseQuery() {
      const params = {};
      const q = window.location.search.substring(1);
      if (!q) return params;
      q.split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if (!key) return;
        params[decodeURIComponent(key)] = decodeURIComponent(value || "");
      });
      return params;
    }

    function initDailyState() {
      const today = getTodayString();
      const storedDate = localStorage.getItem(KEY_DATE);

      if (storedDate !== today) {
        localStorage.setItem(KEY_DATE, today);
        localStorage.setItem(KEY_PLAYS, "0");
        localStorage.removeItem(KEY_UNLIMITED);
      }

      const plays = parseInt(localStorage.getItem(KEY_PLAYS) || "0", 10);
      updatePlaysUI(plays);
      updateUnlimitedUI();

      const supporter = localStorage.getItem(KEY_SUPPORTER) === "true";
      if (supporter) {
        document.getElementById("supporterBadge").style.display = "inline-flex";
      }

      document.getElementById("todayLabel").textContent = `æœ¬æ—¥ï¼š${today}`;
    }

    function updatePlaysUI(plays) {
      const playsLeftEl = document.getElementById("playsLeft");
      const unlimitedDate = localStorage.getItem(KEY_UNLIMITED);
      const today = getTodayString();
      const unlimitedToday = unlimitedDate === today;

      if (unlimitedToday) {
        playsLeftEl.textContent = "âˆ";
      } else {
        const left = Math.max(0, 3 - plays);
        playsLeftEl.textContent = String(left);
      }
    }

    function updateUnlimitedUI() {
      const text = document.getElementById("unlimitedStatus");
      const unlimitedDate = localStorage.getItem(KEY_UNLIMITED);
      const today = getTodayString();
      if (unlimitedDate === today) {
        text.textContent = "ä»Šæ—¥ã¯ç„¡åˆ¶é™è¨ºæ–­ãŒè§£æ”¾ã•ã‚Œã¦ã„ã¾ã™ ğŸ‰";
      } else {
        text.textContent = "â€» æ—¥ä»˜ãŒå¤‰ã‚ã‚‹ã¨ç„¡æ–™å›æ•°ã¯è‡ªå‹•ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚";
      }
    }

    function canPlay() {
      const unlimitedDate = localStorage.getItem(KEY_UNLIMITED);
      const today = getTodayString();
      if (unlimitedDate === today) return true;
      const plays = parseInt(localStorage.getItem(KEY_PLAYS) || "0", 10);
      return plays < 3;
    }

    function recordPlay() {
      const unlimitedDate = localStorage.getItem(KEY_UNLIMITED);
      const today = getTodayString();
      if (unlimitedDate === today) {
        const plays = parseInt(localStorage.getItem(KEY_PLAYS) || "0", 10);
        updatePlaysUI(plays);
        return;
      }
      let plays = parseInt(localStorage.getItem(KEY_PLAYS) || "0", 10);
      plays += 1;
      localStorage.setItem(KEY_PLAYS, String(plays));
      updatePlaysUI(plays);
    }

    function showLimitBlock() {
      document.getElementById("limitBlock").style.display = "block";
    }

    function hideLimitBlock() {
      document.getElementById("limitBlock").style.display = "none";
    }

    function unlockUnlimitedToday(message) {
      const today = getTodayString();
      localStorage.setItem(KEY_UNLIMITED, today);
      updateUnlimitedUI();
      const plays = parseInt(localStorage.getItem(KEY_PLAYS) || "0", 10);
      updatePlaysUI(plays);
      if (message) showToast(message);
    }

    function markSupporter() {
      localStorage.setItem(KEY_SUPPORTER, "true");
      document.getElementById("supporterBadge").style.display = "inline-flex";
    }

    // ===== åœ°é›·åº¦è¨ºæ–­ï¼ˆè¦æ±‚ç³»ã‚’ã‹ãªã‚Šå³ã—ã‚ã«è¦‹ã‚‹ï¼‰ =====
    function evaluateMessage(text, mood) {
      const original = text;
      const normalized = original
        .replace(/ï¼/g, "!")
        .replace(/ï¼Ÿ/g, "?")
        .toLowerCase();

      const deadlyPatterns = [
        "ãã‚“ãªã«æ€’ã‚‹ã»ã©",
        "å¤§ã’ã•",
        "ãƒ’ã‚¹ãƒ†ãƒª",
        "æ›´å¹´æœŸ",
        "é–‰çµŒ",
        "å¥³ã£ã¦",
        "ã ã‹ã‚‰ãŠå‰ã¯",
        "å°‚æ¥­ä¸»å©¦ã®ãã›ã«"
      ];

      const dangerPatterns = [
        "è½ã¡ç€ã„ã¦",
        "ã‚«ãƒ«ã‚·ã‚¦ãƒ ",
        "ä¿ºã ã£ã¦",
        "ä¿ºã‚‚ç–²ã‚Œã¦ã‚‹",
        "ã§ã‚‚ã•",
        "ãŸã„ã—ãŸã“ã¨",
        "ãã‚“ãªã“ã¨ãã‚‰ã„",
        "æ°—ã«ã—ã™ã",
        "é¢å€’ãã•ã„",
        "ã‚ã‚“ã©ãã•ã„",
        "æ™®é€šã¯",
        "è¨€ã£ãŸã‚ˆã­",
        "è¨€ã£ãŸã˜ã‚ƒã‚“",
        "ä½•å›åŒã˜ã“ã¨",
        "ã‚„ã£ã¨ã„ã¦",
        "ç‰‡ä»˜ã‘ã¨ã„ã¦",
        "è¿ãˆã«è¡Œã£ã¦",
        "é€ã£ã¦ã£ã¦"
      ];

      const warnPatterns = [
        "ã¾ãã„ã„ã˜ã‚ƒã‚“",
        "ã¨ã‚Šã‚ãˆãš",
        "å¾Œã§ã‚„ã‚‹",
        "ä»Šå¿™ã—ã„",
        "å¿˜ã‚Œã¦ãŸ",
        "ãã‚“ãªã¤ã‚‚ã‚Šã˜ã‚ƒ",
        "ã”ã‚ã‚“ã£ã¦ã°"
      ];

      const safePatterns = [
        "ã”ã‚ã‚“",
        "æœ¬å½“ã«ã”ã‚ã‚“",
        "ã‚ã‚ŠãŒã¨ã†",
        "åŠ©ã‹ã£ã¦ã‚‹",
        "æ‰‹ä¼ã†",
        "ä»»ã›ã¦",
        "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†",
        "èã‹ã›ã¦",
        "è©±ã‚’èã",
        "æ°—æŒã¡",
        "å°Šæ•¬ã—ã¦ã‚‹",
        "æ„Ÿè¬ã—ã¦ã‚‹",
        "ç„¡ç†ã—ãªã„ã§"
      ];

      let score = 0;
      let hitDeadly = false;

      deadlyPatterns.forEach(p => {
        if (original.includes(p)) {
          score += 4;
          hitDeadly = true;
        }
      });

      dangerPatterns.forEach(p => {
        if (original.includes(p)) {
          score += 2;
        }
      });

      warnPatterns.forEach(p => {
        if (original.includes(p)) {
          score += 1;
        }
      });

      safePatterns.forEach(p => {
        if (original.includes(p)) {
          score -= 1;
        }
      });

      // ==== è¡Œå‹•è¦æ±‚ã®æ¤œå‡ºï¼ˆã“ã“ã‚’ã‹ãªã‚Šå³ã—ã‚ï¼‰ ====
      const requestRegexes = [
        /ã¦ãã‚Œã‚‹[ï¼Ÿ?]?/g,
        /ã¦ãã‚Œãªã„[ï¼Ÿ?]?/g,
        /ã¦ã»ã—ã„[ã€‚ï¼Ÿ?ï¼!]?/g,
        /ã—ã¨ã„ã¦/g,
        /ã—ã¨ã„ã¦ãã‚Œã‚‹/g,
        /ã‚„ã£ã¨ã„ã¦/g,
        /ç‰‡ä»˜ã‘ã¨ã„ã¦/g,
        /è¿ãˆã«è¡Œã£ã¦/g,
        /è¿ãˆã«ãã¦/g,
        /é€ã£ã¦ã£ã¦/g,
        /ãŠé¡˜ã„(ã ã‹ã‚‰)?/g,
        /é ¼ã‚€ã‚ˆ?/g
      ];

      let requestHitCount = 0;
      requestRegexes.forEach(re => {
        const matches = original.match(re);
        if (matches) {
          requestHitCount += matches.length;
        }
      });

      if (requestHitCount > 0) {
        // è¦æ±‚ãã®ã‚‚ã®ã«é‡ã‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£
        score += requestHitCount * 2;

        // ä»Šãƒ»ä»Šæ—¥ãªã©ã€æ™‚é–“ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ä»˜ãè¦æ±‚
        if (original.includes("ä»Š") || original.includes("ä»Šæ—¥") || original.includes("ã™ã")) {
          score += 1;
        }

        // ã€Œä¿º / åƒ•ã€ãªã©è‡ªåˆ†éƒ½åˆã‚¢ãƒ”ãƒ¼ãƒ«ã¨ã‚»ãƒƒãƒˆã®è¦æ±‚
        if (original.includes("ä¿º") || original.includes("ã‚ªãƒ¬") || original.includes("åƒ•")) {
          score += 1;
        }
      }

      // ç–²ã‚Œã‚¢ãƒ”ãƒ¼ãƒ«ã¨ã®çµ„ã¿åˆã‚ã›
      const tiredWords = ["ç–²ã‚Œã¦ã‚‹", "ã‚¯ã‚¿ã‚¯ã‚¿", "ã—ã‚“ã©ã„", "å¤§å¤‰ãªã‚“ã "];
      let tiredHit = false;
      tiredWords.forEach(w => {
        if (original.includes(w)) tiredHit = true;
      });
      if (tiredHit && requestHitCount > 0) {
        score += 1; // ã€Œä¿ºã‚‚ã—ã‚“ã©ã„ï¼‹ãŠé¡˜ã„ã€ã¯ã•ã‚‰ã«å±é™º
      }

      // å¥èª­ç‚¹ã‚„ !? ã®å¤šã•
      const qCount = (normalized.match(/\?/g) || []).length;
      const exCount = (normalized.match(/!/g) || []).length;
      if (exCount >= 3) score += 1;
      if (qCount >= 3) score += 1;

      // å¦»ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è£œæ­£
      if (mood === "slightly-angry") score += 1;
      if (mood === "angry") score += 2;

      // ==== ãƒ¬ãƒ™ãƒ«åˆ¤å®šï¼ˆå…¨ä½“çš„ã«å°‘ã—å³ã—ã‚ï¼‰ ====
      let level, label, badgeClass, emoji;
      if (hitDeadly || score >= 4) {
        level = "å³æ­»ç´š";
        label = "é€ä¿¡ã—ãŸç¬é–“ã€éƒ¨å±‹ã®æ°—æ¸©ãŒ2â„ƒä¸‹ãŒã‚‹ã‚„ã¤ã§ã™ã€‚";
        badgeClass = "badge-deadly";
        emoji = "ğŸ’€";
      } else if (score >= 2) {
        level = "å±é™º";
        label = "ã‹ãªã‚Šç«ã«æ²¹ãªã®ã§ã€è¦æ±‚éƒ¨åˆ†ã‚’ä¸€åº¦ãœã‚“ã¶è¦‹ç›´ã—ãŸã»ã†ãŒã‚ˆã•ãã†ã§ã™ã€‚";
        badgeClass = "badge-danger";
        emoji = "ğŸ”¥";
      } else if (score >= 1) {
        level = "ã‚„ã‚„å±é™º";
        label = "ä»Šã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ¬¡ç¬¬ã§ã¯æ™®é€šã«åœ°é›·ã§ã™ã€‚";
        badgeClass = "badge-warn";
        emoji = "âš ï¸";
      } else {
        level = "å®‰å…¨å¯„ã‚Š";
        label = "å°‘ãªãã¨ã‚‚ã€ã“ã®æ–‡é¢ãŒãƒˆãƒ‰ãƒ¡ã«ã¯ãªã‚‰ãªã•ãã†ã§ã™ã€‚";
        badgeClass = "badge-safe";
        emoji = "ğŸ•Šï¸";
      }

      let moodComment = "";
      if (mood === "slightly-angry") {
        moodComment = "ï¼ˆã¡ã‚‡ã„ãŠã“ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ã€è¦æ±‚ã‚’ä¸€æ®µå¼±ãè¨€ã„æ›ãˆã‚‹ã‹ã€åˆ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«å›ã™ã¨å®‰å¿ƒã§ã™ã€‚ï¼‰";
      } else if (mood === "angry") {
        moodComment = "ï¼ˆã‚¬ãƒãŠã“ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä»Šã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä½•ã‹ã‚’ã€Œé ¼ã‚€ã€ã®ã¯ã€åŸºæœ¬çš„ã«å…¨éƒ¨å±é™ºå¯„ã‚Šã§ã™ã€‚ï¼‰";
      }

      let suggest;
      if (level === "å³æ­»ç´š") {
        suggest = "ä¸€åº¦å…¨éƒ¨æ¶ˆã—ã¦ã€ã€ã¾ãšã¯æœ¬å½“ã«ã”ã‚ã‚“ã€ã ã‘é€ã‚‹ã‹ã€ä»Šæ—¥ã¯é€ã‚‰ãªã„é¸æŠè‚¢ã‚‚ã‚ã‚Šã§ã™ã€‚è¦æ±‚ã¯æ˜æ—¥ä»¥é™ã«ã€‚";
      } else if (level === "å±é™º") {
        suggest = "ã€ŒãŠé¡˜ã„ã€ã€Œã€œã—ã¦ãã‚Œã‚‹ï¼Ÿã€ã®éƒ¨åˆ†ã‚’ã„ã£ãŸã‚“å…¨éƒ¨å‰Šã£ã¦ã€åŠ´ã„ã¨è¬ç½ªã ã‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
      } else if (level === "ã‚„ã‚„å±é™º") {
        suggest = "è¦æ±‚ã®é‡ã‚’3å‰²ã‚«ãƒƒãƒˆã—ã¦ã€ã€ä»Šã§ããã†ï¼Ÿç„¡ç†ãªã‚‰åˆ¥ã®æ—¥ã§ã‚‚å¤§ä¸ˆå¤«ã€ã®ã‚ˆã†ãªé€ƒã’é“ã‚’ä¸€æ–‡è¶³ã™ã¨ã ã„ã¶ãƒã‚¤ãƒ«ãƒ‰ã«ãªã‚Šã¾ã™ã€‚";
      } else {
        suggest = "ã“ã®æ–‡é¢ãªã‚‰OKå¯„ã‚Šã€‚ã‚‚ã—ä½•ã‹é ¼ã‚€ãªã‚‰ã€ã€ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã€‚ä½™è£•ãŒã‚ã‚‹ã¨ãã§ã„ã„ã‹ã‚‰ã€œã€ã¨ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‚’è¶³ã—ã¦é€ã‚‹ã¨ã‚ˆã‚Šå®‰å…¨ã§ã™ã€‚";
      }

      return { level, label, badgeClass, emoji, moodComment, suggest };
    }

    function renderResult(result) {
      const container = document.getElementById("resultArea");
      container.innerHTML = "";

      const main = document.createElement("div");
      main.className = "result-main";

      const badge = document.createElement("span");
      badge.className = "badge " + result.badgeClass;
      badge.textContent = result.level;

      const levelText = document.createElement("span");
      levelText.className = "level-text";
      levelText.textContent = result.emoji + " " + result.label;

      main.appendChild(badge);
      main.appendChild(levelText);

      const comment = document.createElement("div");
      comment.className = "result-comment";
      comment.textContent = result.moodComment;

      const suggest = document.createElement("div");
      suggest.className = "result-suggest";
      suggest.textContent = result.suggest;

      container.appendChild(main);
      if (result.moodComment) container.appendChild(comment);
      container.appendChild(suggest);
    }

    function getResultSummaryForShare() {
      const area = document.getElementById("resultArea");
      if (!area.textContent.trim()) return null;
      return area.innerText.trim().replace(/\s+/g, " ");
    }

    document.addEventListener("DOMContentLoaded", () => {
      initDailyState();

      const params = parseQuery();
      if (params.payment === "success") {
        unlockUnlimitedToday("æ±ºæ¸ˆå®Œäº†ã¨ã¿ãªã—ã¦ã€ä»Šæ—¥ã¯ç„¡åˆ¶é™è¨ºæ–­ã‚’è§£æ”¾ã—ã¾ã—ãŸã€‚");
      }
      if (params.tip === "done") {
        markSupporter();
        showToast("æŠ•ã’éŠ­ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼");
      }

      document.getElementById("checkButton").addEventListener("click", () => {
        const text = document.getElementById("lineText").value.trim();
        const mood = document.getElementById("moodSelect").value;

        if (!text) {
          showToast("ã¾ãšã¯å¦»ã«é€ã‚ã†ã¨ã—ã¦ã„ã‚‹æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        if (!canPlay()) {
          showLimitBlock();
          return;
        }

        hideLimitBlock();
        recordPlay();
        const result = evaluateMessage(text, mood);
        renderResult(result);
      });

      document.getElementById("sampleButton").addEventListener("click", () => {
        const sample = "ã•ã£ãã®è¨€ã„æ–¹ã¯ã¡ã‚‡ã£ã¨ã‚­ãƒ„ããªã„ï¼Ÿä¿ºã ã£ã¦æ¯æ—¥ä»•äº‹ã§ã‚¯ã‚¿ã‚¯ã‚¿ãªã‚“ã ã‘ã©ã€‚å¸°ã‚Šã«ç‰›ä¹³è²·ã£ã¦ãã¦ãã‚Œã‚‹ï¼Ÿ";
        document.getElementById("lineText").value = sample;
        showToast("ã‚µãƒ³ãƒ—ãƒ«æ–‡ã‚’å…¥ã‚Œã¾ã—ãŸã€‚è¨ºæ–­ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
      });

      document.getElementById("limitCloseButton").addEventListener("click", () => {
        hideLimitBlock();
      });

      document.getElementById("dummyPaymentLink").addEventListener("click", (e) => {
        e.preventDefault();
        showToast("æœ¬ç•ªã§ã¯ã“ã“ã‹ã‚‰æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸é·ç§»ã—ã¾ã™ã€‚");
      });

      document.getElementById("shareXButton").addEventListener("click", () => {
        const summary = getResultSummaryForShare();
        if (!summary) {
          showToast("ã¾ãšã¯è¨ºæ–­ã—ã¦ã‹ã‚‰ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const text = "å¦»LINEåœ°é›·ãƒã‚§ãƒƒã‚«ãƒ¼ã§è¨ºæ–­ã—ãŸçµæœï¼š\n" +
                     summary +
                     "\n\n#å¦»LINEåœ°é›·ãƒã‚§ãƒƒã‚«ãƒ¼";
        const url = window.location.href.split("?")[0];
        const shareUrl = "https://x.com/intent/tweet?text=" +
          encodeURIComponent(text) +
          "&url=" +
          encodeURIComponent(url);
        window.open(shareUrl, "_blank");
      });

      document.getElementById("copySummaryButton").addEventListener("click", async () => {
        const summary = getResultSummaryForShare();
        if (!summary) {
          showToast("ã¾ãšã¯è¨ºæ–­ã—ã¦ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const text = "å¦»LINEåœ°é›·ãƒã‚§ãƒƒã‚«ãƒ¼ è¨ºæ–­çµæœï¼š\n" + summary;
        try {
          await navigator.clipboard.writeText(text);
          showToast("è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        } catch {
          showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });

      document.getElementById("debugUnlockButton").addEventListener("click", () => {
        unlockUnlimitedToday("ãƒ†ã‚¹ãƒˆç”¨ï¼šä»Šæ—¥ã¯ç„¡åˆ¶é™è¨ºæ–­ã«ãªã‚Šã¾ã—ãŸã€‚");
      });

      document.getElementById("debugTipButton").addEventListener("click", () => {
        markSupporter();
        showToast("ãƒ†ã‚¹ãƒˆç”¨ï¼šã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ©ã‚°ã‚’ONã«ã—ã¾ã—ãŸã€‚");
      });
    });
  </script>
</body>
</html>
